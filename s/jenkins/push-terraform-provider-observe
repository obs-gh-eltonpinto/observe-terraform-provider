#!/bin/bash -xe
set -uxe
set -o pipefail
VERSION=`git describe --tags --always`

mydir=$(dirname $0)
git fetch origin
cd "$mydir/../.."

# Terraform infers plugin version from filename. For this reason, it is more
# convenient to package plugins in a zip in order to maintain version integrity
# while being able to pull "latest"
function publish() {
    local GOOS_GOARCH="$1"
    local OUTPUT="terraform-provider-observe_${2}.zip"
    zip -mqj $OUTPUT bin/${GOOS_GOARCH}/terraform-provider-observe_${VERSION}
    aws s3 cp ${OUTPUT} s3://observeinc/terraform-provider-observe/${GOOS_GOARCH}/${OUTPUT}
    aws s3api put-object-acl --bucket observeinc --key terraform-provider-observe/${GOOS_GOARCH}/${OUTPUT} --acl public-read
    rm ${OUTPUT}
}

make docker-package

publish darwin_amd64 ${VERSION}
publish linux_amd64 ${VERSION}

# only link latest to tagged releases
if [[ $VERSION =~ "." ]]; then
    publish darwin_amd64 latest
    publish linux_amd64 latest
fi
